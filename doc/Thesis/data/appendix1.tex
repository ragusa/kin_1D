%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  New template code for TAMU Theses and Dissertations starting Fall 2016.
%
%
%  Author: Sean Zachary Roberson 
%	 Version 3.16.09
%  Last updated 9/12/2016
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                           APPENDIX A 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\phantomsection

\chapter{\uppercase{Derivations}}

%%---------------------------------------------------------------------------%%
\section{Derivation of IQS with CFEM Diffusion}
%%---------------------------------------------------------------------------%%

Multigroup diffusion equation with delayed neutron precrusors:
\begin{align}
\frac{\partial}{\partial t}\left(\frac{\phi^g}{v^g}\right) =& \chi_p^g \sum_{g'=1}^G (1-\beta) \frac{\nu^{g'} \Sigma_f^{g'}}{\keff} \phi^{g'} -  \left( -\div D^g \grad  + \Sigma_r^g \right) \phi^g  \nonumber \\
&  + \sum_{g'\neq g}^G\Sigma_s^{g'\to g} \phi^{g'}  + \sum_{i=1}^I\chi_{d,i}^g\lambda_i C_i \ , \quad 1 \le g \le G 
\label{eq:diffusion}
\end{align}
\be
\frac{dC_i}{dt} = \beta_i\sum_{g=1}^G \frac{\nu^{g'} \Sigma_f^{g'}}{\keff} \phi^{g} - \lambda_i C_i \ , \quad 1 \le i \le I 
\label{eq:precA}
\ee

With reflecting and vacuum boundary conditions:
\be 
\begin{cases} 
\grad\phi^g = 0, &\vr\in\partial\D_2 \\ D\grad\phi^g-\frac{1}{2}\phi^g = 0, &\vr\in\partial\D_3
\end{cases}
\ee
\be 
\text{with } \partial\D=\partial\D_2\cup\partial\D_3 \nonumber
\ee

Multiplying Equation~\ref{eq:diffusion} by the adjoint solution $\phi^{*g}$ and Equation~\ref{eq:precA} by $C^*=\sum_{g=1}^G\phi^{*g} \chi_{d,i}^g$ for test functions and integrating in space:
\begin{align}
&\frac{d}{dt}\left(\phi^{*g},\frac{1}{v^g}\phi^g\right)_\D = \left(\phi^{*g}\chi_p^g(1-\beta),\sum_{g'=1}^G \frac{\nu^{g'} \Sigma_f^{g'}}{\keff} \phi^{g'}\right)_\D + \left(\grad \phi^{*g},D^g \grad \phi^g\right)_\D \nonumber \\
& - \frac{1}{2}\left\langle\phi^{*g},\phi^{g}\right\rangle_{\partial \D_3} - \left(\phi^{*g},\Sigma_r^g\phi^g\right)_\D + \sum_{g'\neq g}^G\left(\phi^{*g},\Sigma_s^{g'\to g} \phi^{g'}\right)_\D + \sum_{i=1}^I \left(\phi^{*g}\chi_{d,i}^g,\lambda_i C_i\right)_\D
\label{eq:diffweak}
\end{align}
\be
\frac{d}{dt}\left(C^*,C_i\right)_\D = \left(C^* \beta_i,\sum_{g'=1}^G\frac{\nu^{g'} \Sigma_f^{g'}}{\keff}\varphi^{g'}\right)_\D -\left(C^*,\lambda_i C_i\right)_\D
\ee

Summing over groups on both sides of Equation~\ref{eq:diffweak}:
\begin{align}
\frac{d}{dt}&\left(\sum_{g=1}^G\left(\phi^{*g},\frac{1}{v^g}\phi^g\right)_\D\right) = \left(\sum_{g=1}^G\phi^{*g}\chi_p^g(1-\beta),\sum_{g'=1}^G \frac{\nu^{g'} \Sigma_f^{g'}}{\keff} \phi^{g'}\right)_\D  \nonumber \\ 
& + \sum_{g=1}^G\left(\grad \phi^{*g},D^g \grad \phi^g\right)_\D - \frac{1}{2}\sum_{g=1}^G\left\langle\phi^{*g},\phi^{g}\right\rangle_{\partial \D_3} - \sum_{g=1}^G\left(\phi^{*g},\Sigma_r^g\phi^g\right)_\D  \nonumber \\ 
&+ \sum_{g=1}^G\sum_{g'\neq g}^G\left(\phi^{*g},\Sigma_s^{g'\to g} \phi^{g'}\right)_\D + \sum_{i=1}^I \left(\sum_{g=1}^G\phi^{*g}\chi_{d,i}^g,\lambda_i C_i\right)_\D 
\end{align}

Defining bilinear functions:
\begin{align}
T(\phi^{*},\phi) =& \sum_{g=1}^G\left(\phi^{*g},\frac{1}{v^g}\phi^g\right)_\D \\
C_i(C^*,C_i) =& \left(C^*,C_i\right)_\D \\
F(\phi^{*},\phi) =& \left(\sum_{g=1}^G\phi^{*g}\left(\chi_p^g(1-\beta)+\sum_{i=1}^I\chi_{d,i}^g\beta_i\right),\sum_{g'=1}^G \frac{\nu^{g'} \Sigma_f^{g'}}{\keff} \phi^{g'}\right)_\D \\
L(\phi^{*},\phi) =& \sum_{g=1}^G\left(-\left(\grad \phi^{*g},D^g \grad \phi^g\right)_\D + \frac{1}{2}\left\langle\phi^{*g},\phi^{g}\right\rangle_{\partial \D_3} + \left(\phi^{*g},\Sigma_r^g\phi^g\right)_\D \right) \\
S(\phi^{*},\phi) =& \sum_{g=1}^G\sum_{g'\neq g}^G\left(\phi^{*g},\Sigma_s^{g'\to g} \phi^{g'}\right)_\D \\
F_{d,i}(\phi^*,\phi) =& \left(\beta_i\sum_{g=1}^G\phi^{*g} \chi_{d,i}^g,\sum_{g'=1}^G\frac{\nu^{g'} \Sigma_f^{g'}}{\keff}\phi^{g'}\right)_\D \\
S_{d,i}(\phi^*,\phi) =& \left(\sum_{g=1}^G\phi^{*g} \chi_{d,i}^g,\lambda_i C_i\right)_\D \\
P_i(C^*,\phi) =& \left(C^*\beta_i,\sum_{g'=1}^G\frac{\nu^{g'} \Sigma_f^{g'}}{\keff}\phi^{g'}\right)_\D \\
D_i(C^*,C_i) =& \left(C^*,\lambda_i C_i\right)_\D
\end{align}

Rewriting the flux and precursor equations:
\be
\frac{d}{dt} T(\phi^{*},\phi) = F(\phi^{*},\phi) - \sum_{i=1}^I F_{d,i}(\phi^*,\phi) - L(\phi^{*},\phi) + S(\phi^{*},\phi) + \sum_{i=1}^I S_{d,i}(\phi^*,\phi)
\ee
\be
\frac{d}{dt} C_i(C^*,C_i) = P_i(C^*,\phi) - D_i(C^*,C_i)
\ee

Doing IQS factorization:
\begin{align}
\frac{d}{dt} T(\phi^{*},\varphi) = F(\phi^{*},\varphi) - \sum_{i=1}^I F_{d,i}(\phi^*,\varphi) &- L(\phi^{*},\varphi) - \frac{1}{p}\frac{dp}{dt}T(\phi^{*},\varphi) \nonumber \\
& + S(\phi^{*},\varphi) + \frac{1}{p}\sum_{i=1}^I S_{d,i}(\phi^*,\phi)
\end{align}
\be
\frac{\partial}{\partial t} C_i(C^*,C_i) = P_i(C^*,\varphi)p - D_i(C^*,C_i)
\ee

Defining PRKE parameters:
\be
\rho = \frac{F(\phi^{*},\varphi) - L(\phi^{*},\varphi) + S(\phi^{*},\varphi)}{F(\phi^{*},\varphi)}
\ee
\be
\bar{\beta} = \sum_{i=1}^I\bar{\beta}_i = \sum_{i=1}^I\frac{F_{d,i}(\phi^*,\varphi)}{F(\phi^{*},\varphi)} = \sum_{i=1}^I\frac{P_i(C^*,\varphi)}{F(\phi^{*},\varphi)}
\ee
\be
\Lambda = \frac{T(\phi^{*},\varphi)}{F(\phi^{*},\varphi)}
\ee
\be
\bar{\lambda}_i = \frac{S_{d,i}(\phi^*,\varphi)}{C_i(C^*,C_i)} = \frac{D_i(C^*,C_i)}{C_i(C^*,C_i)}
\ee
\be
\xi_i = \frac{C_i(C^*,C_i)}{T(\phi^{*},\varphi)}
\ee

Writing implementing parameters:
\be
\frac{dp}{dt}=\left[\frac{\rho-\bar{\beta}}{\Lambda}\right]p + \sum_{i=1}^I\bar{\lambda}_i\xi_i + p\frac{1}{T(\phi^{*},\varphi)}\frac{\partial}{\partial t} T(\phi^{*},\varphi)
\ee
\be
\frac{d\xi_i}{dt}=\frac{\bar{\beta}_i}{\Lambda}p-\bar{\lambda}_i\xi_i \quad 1 \le i \le I 
\ee

Assuming $\frac{\partial}{\partial t} T(\phi^{*},\varphi) = 0$:
\be
\frac{dp}{dt}=\left[\frac{\rho-\bar{\beta}}{\Lambda}\right]p+\sum_{i=1}^I\bar{\lambda}_i\xi_i
\label{eq:p}
\ee
\be
\frac{d\xi_i}{dt}=\frac{\bar{\beta}_i}{\Lambda}p-\bar{\lambda}_i\xi_i \quad 1 \le i \le I 
\label{eq:xi}
\ee

%%---------------------------------------------------------------------------%%
\section{Proof of Flux-Shape Solution Inequality}
%%---------------------------------------------------------------------------%%

There has been a reoccurring question that if shape and amplitude have same time step and integration scheme, the solution should be equal to the full flux solution.  This section is meant to prove that this notion is not true.  For simplicity, the integration scheme chosen was backward-Euler.  Writing the shape equation in time discretized form:

\begin{align}
&\frac{T^{n+1}(\phi^{*},\varphi)-T^{n}(\phi^{*},\varphi)}{\Delta t} = F^{n+1}(\phi^{*},\varphi) - \sum_{i=1}^I F_{d,i}^{n+1}(\phi^{*},\varphi) - L^{n+1}(\phi^{*},\varphi) -  \nonumber \\
&- \frac{1}{p^{n+1}}\frac{p^{n+1} - p^n}{\Delta t}T^{n+1}(\phi^{*},\varphi) + S^{n+1}(\phi^{*},\varphi) + \frac{1}{p^{n+1}}\sum_{i=1}^I S_{d,i}^{n+1}(\phi^{*},C_i)
\end{align}

where $n$ is the index for the previous time step and $n+1$ is the next one.  Multiplying both sides by $p^{n+1}$:
\begin{align}
&p^{n+1}\frac{T^{n+1}(\phi^{*},\varphi)-T^{n}(\phi^{*},\varphi)}{\Delta t} = F^{n+1}(\phi^{*},\varphi)p^{n+1} - \sum_{i=1}^I F_{d,i}^{n+1}(\phi^{*},\varphi)p^{n+1} \nonumber \\
& - L^{n+1}(\phi^{*},\varphi)p^{n+1} - \frac{p^{n+1} - p^n}{\Delta t}T^{n+1}(\phi^{*},\varphi) + S^{n+1}(\phi^{*},\varphi)p^{n+1} + \sum_{i=1}^I S_{d,i}^{n+1}(\phi^{*},C_i)
\end{align}

Notice that for any bilinear form with $\varphi$, when multiplied by $p^{n+1}$ is the same form, but with $\phi$ instead. So:
\begin{align}
p^{n+1}&\frac{T^{n+1}(\phi^{*},\varphi)-T^{n}(\phi^{*},\varphi)}{\Delta t} + \frac{p^{n+1} - p^n}{\Delta t}T^{n+1}(\phi^{*},\varphi)= F^{n+1}(\phi^{*},\phi)  \nonumber \\
&- \sum_{i=1}^I F_{d,i}^{n+1}(\phi^{*},\phi) - L^{n+1}(\phi^{*},\phi) + S^{n+1}(\phi^{*},\phi) + \sum_{i=1}^I S_{d,i}^{n+1}(\phi^{*},C_i)
\label{eq:dshape}
\end{align}

Now the full flux equation is discretized the same way:
\begin{align}
\frac{T^{n+1}(\phi^{*},\phi)-T^{n}(\phi^{*},\phi)}{\Delta t} =& F^{n+1}(\phi^{*},\phi)- \sum_{i=1}^I F_{d,i}^{n+1}(\phi^{*},\phi) \nonumber \\
& - L^{n+1}(\phi^{*},\phi) + S^{n+1}(\phi^{*},\phi) + \sum_{i=1}^I S_{d,i}^{n+1}(\phi^{*},C_i)
\label{eq:dflux}
\end{align}

Notice that Equations~\ref{eq:dshape}~and~\ref{eq:dflux} have the same right hand side. So the left hand side of each equation can be equated, while converting the left hand side of Equation \ref{eq:dflux} to amplitude and flux:

\begin{align}
\frac{p^{n+1}T^{n+1}(\phi^{*},\varphi)-p^nT^{n}(\phi^{*},\varphi)}{\Delta t} &= p^{n+1}\frac{T^{n+1}(\phi^{*},\varphi)-T^{n}(\phi^{*},\varphi)}{\Delta t} \nonumber \\
&+ \frac{p^{n+1} - p^n}{\Delta t}T^{n+1}(\phi^{*},\varphi)
\label{eq:neq}
\end{align}

From Equation~\ref{eq:p}:
\be
\frac{p^{n+1} - p^n}{\Delta t} = \left[\frac{\rho^{n+1}-\bar{\beta}^{n+1}}{\Lambda^{n+1}}\right]p^{n+1}+\sum_{i=1}^I\bar{\lambda}_i^{n+1}\xi_i^{n+1}
\ee

Substituting the PRKE parameter definitions:
\begin{align}
\frac{p^{n+1} - p^n}{\Delta t} T^{n+1}(\phi^{*},\varphi) =& F^{n+1}(\phi^{*},\phi)- \sum_{i=1}^I F_{d,i}^{n+1}(\phi^{*},\phi) \nonumber \\
& - L^{n+1}(\phi^{*},\phi) + S^{n+1}(\phi^{*},\phi) + \sum_{i=1}^I S_{d,i}^{n+1}(\phi^{*},C_i)
\label{eq:dprke}
\end{align}

Notice how the right hand side of Equation~\ref{eq:dprke} is equal to the right hand side of Equation~\ref{eq:dflux} so:
\be
\frac{p^{n+1} - p^n}{\Delta t} T^{n+1}(\phi^{*},\varphi) = \frac{p^{n+1}T^{n+1}(\phi^{*},\varphi)-p^nT^{n}(\phi^{*},\varphi)}{\Delta t}
\ee

Substituting this into the last term on the right hand side of Equation~\ref{eq:neq}:

\begin{align}
\frac{p^{n+1}T^{n+1}(\phi^{*},\varphi)-p^nT^{n}(\phi^{*},\varphi)}{\Delta t} &= p^{n+1}\frac{T^{n+1}(\phi^{*},\varphi)-T^{n}(\phi^{*},\varphi)}{\Delta t} \nonumber \\
&+ \frac{p^{n+1}T^{n+1}(\phi^{*},\varphi)-p^nT^{n}(\phi^{*},\varphi)}{\Delta t}
\label{eq:neq2}
\end{align}

Which can be written as:
\be
\frac{T^{n+1}(\phi^{*},\varphi)-T^{n}(\phi^{*},\varphi)}{\Delta t} = 0
\ee

 However, this equation is not necessarily true.  The assumption is made that $\frac{dT}{dt} = 0$ when deriving Equation~\ref{eq:p}, but in practice this doesn't always hold up. Therefore, putting the shape and amplitude equations on the same discretization, does not necessarily mean the IQS solution will produce the same solution as the full flux equation.
 
To show this result numerically, the discretized scheme was applied to the one-group, one-dimensional example and five Picard iterations were done each time step for IQS.  The compiled results are shown in Table \ref{tab:neq} by comparing the difference in the volumetric integral of the flux. The results show that there is an average 1\% difference between the full flux solution and IQS.

%\begin{table}
%\centering
%\caption{Numerical results for inequality proof where the compared value is $(1,\phi)$}
%\label{tab:neq}
%\begin{tabular}{llll}
%\csvautotabular{\FiguresDir/inequality_results.csv}
%\end{tabular}
%\end{table}

\begin{table}
\centering
\caption{Numerical results for inequality proof where the compared value is $(1,\phi)$}
\label{tab:neq}
\begin{tabular}{|llll|}
\hline
Time(s) &	Full Flux Solve &	IQS Solve &	Relative Difference \\
\hline
0.0	&	0.90903993 &	0.90903993 &	0		\\
0.1 &	0.91253395 &	0.90903993 &	0.00383 \\
0.2 &	0.92068212 &	0.91341921 &	0.00789 \\
0.3 &	0.93564944 &	0.92419479 &	0.01224 \\
0.4 &	0.96072564 &	0.94502984 &	0.01634 \\
0.5 &	1.00132530 &	0.98193047 &	0.01937 \\
0.6 &	1.06731452 &	1.04589052 &	0.02007 \\
0.7 &	1.13375988 &	1.11085442 &	0.0202 \\
0.8 &	1.19865931 &	1.17468271 &	0.02 \\
0.9 &	1.26133943 &	1.23659429 &	0.01962 \\
1.0 &	1.32173672 &	1.29643586 &	0.01914 \\
1.1 &	1.33970601 &	1.31604696 &	0.01766 \\
1.2 &	1.32132462 &	1.30051903 &	0.01575 \\
1.3 &	1.27831729 &	1.26067046 &	0.0138 \\
1.4 &	1.22290272 &	1.20822518 &	0.012 \\
1.5 &	1.16481963 &	1.15274011 &	0.01037 \\
1.6 &	1.11035980 &	1.10047097 &	0.00891 \\
1.7 &	1.06269788 &	1.05460529 &	0.00762 \\
1.8 &	1.03149816 &	1.02465437 &	0.00663 \\
1.9 &	1.01107465 &	1.00511526 &	0.00589 \\
2.0 &	0.99776339 &	0.99243083 &	0.00534 \\
\hline
\end{tabular}
\end{table}